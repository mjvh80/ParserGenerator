Parts of this code are based on Haskell code written by Martin Sulzmann.